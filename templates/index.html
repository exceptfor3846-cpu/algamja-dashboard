<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¥” ì•Œê°ìì§€ìˆ˜ ëŒ€ì‹œë³´ë“œ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* â”€â”€ ê¸°ë³¸ ë¦¬ì…‹ & ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:       #0d0d0d;
  --card:     #161616;
  --card2:    #1e1e1e;
  --border:   #2a2a2a;
  --text:     #e2e2e2;
  --muted:    #777;
  --accent:   #f5a623;
  --accent2:  #ffc85e;
  --up:       #4caf50;
  --down:     #f44336;
  --hit-col:  #4caf50;
  --miss-col: #f44336;
  --radius:   10px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  min-height: 100vh;
}
a { color: var(--accent); }
select, input, button { font-family: inherit; }

/* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wrap { max-width: 1440px; margin: 0 auto; padding: 24px 20px; }

/* â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  text-align: center;
  padding: 36px 20px 28px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 32px;
}
.header h1 {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: -0.5px;
  margin-bottom: 6px;
}
.header .sub { color: var(--muted); font-size: 0.85rem; margin-bottom: 20px; }

.disclaimer {
  background: #1a1500;
  border: 1px solid #3a2e00;
  border-left: 4px solid var(--accent);
  border-radius: var(--radius);
  padding: 14px 18px;
  color: #c8a84b;
  font-size: 0.85rem;
  max-width: 860px;
  margin: 0 auto 16px;
  text-align: left;
}

.criteria {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 18px;
  max-width: 860px;
  margin: 0 auto;
  text-align: left;
}
.criteria h4 { color: var(--accent); font-size: 0.82rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
.criteria ol { padding-left: 18px; color: var(--muted); font-size: 0.85rem; }
.criteria li { margin: 4px 0; }

.channel-banner {
  display: flex;
  align-items: center;
  gap: 10px;
  max-width: 860px;
  margin: 16px auto 0;
  padding: 12px 18px;
  background: linear-gradient(135deg, #1a1e2e, #1e2838);
  border: 1px solid #2a3a4a;
  border-radius: var(--radius);
  color: var(--text);
  text-decoration: none;
  font-size: 0.88rem;
  transition: border-color .2s, transform .15s;
}
.channel-banner:hover { border-color: #4a9eff; transform: translateY(-1px); }
.channel-icon { font-size: 1.3rem; }
.channel-text { flex: 1; }
.channel-text b { color: #6ab4ff; }
.channel-arrow { color: var(--muted); font-size: 1.1rem; transition: transform .2s; }
.channel-banner:hover .channel-arrow { transform: translateX(4px); color: #6ab4ff; }

/* â”€â”€ ìŠ¤íƒ¯ ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 28px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
  transition: border-color .2s;
}
.stat-card:hover { border-color: var(--accent); }
.stat-card .lbl { color: var(--muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: .8px; margin-bottom: 8px; }
.stat-card .val { font-size: 2rem; font-weight: 700; }
.stat-card.main  .val { color: var(--accent); }
.stat-card.hits  .val { color: var(--hit-col); }
.stat-card.fails .val { color: var(--miss-col); }

/* â”€â”€ ìì‚°ë³„ ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.asset-summary {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 20px;
  margin-bottom: 28px;
}
.asset-summary h3 { font-size: 0.9rem; color: var(--accent); margin-bottom: 14px; }
.asset-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.asset-chip {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 0.82rem;
  min-width: 140px;
}
.asset-chip .name { color: var(--text); font-weight: 600; }
.asset-chip .rate { margin-top: 4px; }
.rate-bar-wrap { background: #1a1a1a; border-radius: 4px; height: 4px; margin-top: 5px; overflow: hidden; }
.rate-bar { height: 100%; border-radius: 4px; background: var(--accent); transition: width .4s; }

/* â”€â”€ íˆ´ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 16px;
}
.toolbar-left { display: flex; gap: 8px; flex-wrap: wrap; }
.toolbar-right { color: var(--muted); font-size: 0.8rem; }

/* â”€â”€ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 9px 18px;
  border: none;
  border-radius: 8px;
  font-size: 0.88rem;
  font-weight: 600;
  cursor: pointer;
  transition: all .18s;
  white-space: nowrap;
}
.btn-primary  { background: var(--accent); color: #000; }
.btn-primary:hover  { background: var(--accent2); }
.btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-secondary:hover { background: var(--card2); }
.btn-sm { padding: 5px 10px; font-size: 0.78rem; border-radius: 6px; font-weight: 600; }
.btn-hit  { background: rgba(76,175,80,.12); color: var(--hit-col); border: 1px solid var(--hit-col); }
.btn-hit.on  { background: var(--hit-col); color: #fff; }
.btn-miss { background: rgba(244,67,54,.12); color: var(--miss-col); border: 1px solid var(--miss-col); }
.btn-miss.on { background: var(--miss-col); color: #fff; }
.btn-del  { background: transparent; border: 1px solid #2a2a2a; color: #555; }
.btn-del:hover { border-color: var(--miss-col); color: var(--miss-col); }
.btn-edit { background: transparent; border: 1px solid #2a2a2a; color: #555; }
.btn-edit:hover { border-color: var(--accent); color: var(--accent); }
.btn:disabled { opacity: .5; cursor: not-allowed; }

/* â”€â”€ ì–´ë“œë¯¼ ì œì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* .admin-only ì´ˆê¸° ìˆ¨ê¹€ì€ JSì—ì„œ inline styleë¡œ ì²˜ë¦¬ */

/* â”€â”€ ìˆ«ì ì…ë ¥ (ì ì¤‘/ì‹¤íŒ¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.num-input {
  width: 56px;
  background: #0d0d0d;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 3px 6px;
  border-radius: 5px;
  font-size: 0.85rem;
  text-align: center;
  outline: none;
}
.num-input:focus { border-color: var(--accent); }
.num-display { font-weight: 600; }
.num-hit  { color: var(--hit-col); }
.num-miss { color: var(--miss-col); }

/* â”€â”€ ë¡œê·¸ì¸ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.admin-bar {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  color: var(--accent);
  border: 1px solid var(--accent);
  cursor: pointer;
  background: transparent;
  white-space: nowrap;
}
.admin-bar:hover { background: rgba(245,166,35,.08); }

/* â”€â”€ í…Œì´ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl-wrap {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow-x: auto;
  margin-bottom: 28px;
}
table { width: 100%; border-collapse: collapse; }
thead th {
  background: #111;
  padding: 11px 14px;
  text-align: left;
  font-size: 0.72rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .7px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody td {
  padding: 11px 14px;
  border-bottom: 1px solid #1f1f1f;
  white-space: nowrap;
  font-size: 0.88rem;
}
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover td { background: rgba(255,255,255,.025); }
.dir-up   { color: var(--up);   font-weight: 700; }
.dir-down { color: var(--down); font-weight: 700; }
.chg-up   { color: var(--up); }
.chg-down { color: var(--down); }
.badge-pending { color: var(--muted); background: #1f1f1f; padding: 2px 8px; border-radius: 4px; font-size: 0.78rem; }
.badge-hit  { color: var(--hit-col); font-weight: 600; }
.badge-miss { color: var(--miss-col); font-weight: 600; }
.tbl-empty { text-align: center; padding: 48px; color: var(--muted); }
.btn-group { display: flex; gap: 5px; align-items: center; }

/* â”€â”€ ì„¤ì • íŒ¨ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 28px;
}
.settings h3 { font-size: 0.9rem; color: var(--accent); margin-bottom: 16px; }
.settings-row { display: flex; align-items: flex-end; gap: 14px; flex-wrap: wrap; }
.fld label { display: block; color: var(--muted); font-size: 0.78rem; margin-bottom: 6px; }
.fld select, .fld input {
  background: #0d0d0d;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 9px 12px;
  border-radius: 8px;
  font-size: 0.88rem;
  outline: none;
}
.fld select:focus, .fld input:focus { border-color: var(--accent); }
.settings-info { color: var(--muted); font-size: 0.8rem; margin-top: 10px; }

/* â”€â”€ ì°¨íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 28px;
}
.chart-section h3 { font-size: 0.9rem; color: var(--accent); margin-bottom: 6px; }
.chart-desc { color: var(--muted); font-size: 0.8rem; margin-bottom: 20px; }
.chart-wrap { position: relative; height: 280px; }

/* â”€â”€ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  z-index: 200;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.overlay.show { display: flex; }
.modal {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 30px;
  width: 100%;
  max-width: 460px;
  animation: popIn .2s ease;
}
@keyframes popIn { from { opacity:0; transform:scale(.96); } to { opacity:1; transform:scale(1); } }
.modal h2 { font-size: 1.1rem; color: var(--accent); margin-bottom: 22px; }
.form-row { margin-bottom: 16px; }
.form-row label { display: block; color: var(--muted); font-size: 0.78rem; margin-bottom: 6px; }
.form-row select,
.form-row input {
  width: 100%;
  background: #0d0d0d;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 0.92rem;
  outline: none;
  transition: border-color .15s;
}
.form-row select:focus,
.form-row input:focus { border-color: var(--accent); }
.dir-btns { display: flex; gap: 10px; }
.dir-btn {
  flex: 1; padding: 11px; border-radius: 8px;
  border: 2px solid var(--border); background: #111;
  color: var(--muted); font-weight: 700; cursor: pointer;
  text-align: center; font-size: 0.95rem; transition: all .15s;
}
.dir-btn.up.sel   { border-color: var(--up);   color: var(--up);   background: rgba(76,175,80,.1); }
.dir-btn.down.sel { border-color: var(--down); color: var(--down); background: rgba(244,67,54,.1); }
.modal-actions { display: flex; gap: 10px; margin-top: 22px; }

/* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast {
  position: fixed; bottom: 30px; right: 30px; z-index: 999;
  background: #222; border: 1px solid var(--border);
  color: var(--text); padding: 12px 20px; border-radius: 10px;
  font-size: 0.88rem; box-shadow: 0 4px 20px rgba(0,0,0,.5);
  transform: translateY(20px); opacity: 0;
  transition: all .25s;
  pointer-events: none;
}
#toast.show { transform: translateY(0); opacity: 1; }

/* â”€â”€ ë°˜ì‘í˜• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 900px) {
  .stats { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 500px) {
  .stats { grid-template-columns: 1fr 1fr; }
  .header h1 { font-size: 1.6rem; }
}
</style>
</head>
<body>

<div class="wrap">

  <!-- â”€â”€ í—¤ë” â”€â”€ -->
  <div class="header">
    <h1>ğŸ¥” ì•Œê°ìì§€ìˆ˜ ëŒ€ì‹œë³´ë“œ</h1>
    <p class="sub">íŠ¹ì • ìœ íŠœë²„ì˜ ìì‚° ì˜ˆì¸¡ ì ì¤‘ë¥  ì¶”ì  ì‹œìŠ¤í…œ</p>

    <div class="disclaimer">
      âš ï¸ ì´ ì§€ìˆ˜ëŠ” íŠ¹ì • ìœ íŠœë²„ì˜ ìì‚° ì˜ˆì¸¡ì´ ë†’ì€ í™•ë¥ ë¡œ <b>ë°˜ëŒ€ë¡œ ì›€ì§ì¸ë‹¤</b>ëŠ” ê°€ì„¤ì„ ê²€ì¦í•˜ê¸° ìœ„í•¨ì´ë©°,
      í•´ë‹¹ ìœ íŠœë²„ë¥¼ ë¹„ë°©í•  ì˜ë„ê°€ ì—†ìŒì„ ë¶„ëª…íˆ í•©ë‹ˆë‹¤.
      ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ê°€ì„¤ì´ ë§ë‹¤ë©´.... ì•Œê°ì ê·¸ëŠ” ì‹ ì´ë‹¤...
    </div>

    <div class="criteria">
      <h4>ğŸ“‹ ì•Œê°ìì§€ìˆ˜ í‰ê°€ ê¸°ì¤€</h4>
      <ol>
        <li>ë§ì€ íˆ¬ììë“¤ì´ ê·¸ëŸ¬í•˜ë“¯ ì˜ìƒì€ ë³´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¨ì§€ ì¸ë„¤ì¼ë§Œìœ¼ë¡œ í•´ë‹¹ ìì‚°ì˜ ê¸ì • / ë¶€ì • ì˜ˆì¸¡ì„ íŒë‹¨í•©ë‹ˆë‹¤.</li>
        <li>ì ì¤‘ ì—¬ë¶€ = í•´ë‹¹ ìì‚°ì˜ ì˜ìƒ ê²Œì‹œ ì‹œì  ê°€ê²© ëŒ€ë¹„ ë‹¤ìŒ ì˜ìƒ ê²Œì‹œ ì‹œì  ê°€ê²©ì˜ ìƒìŠ¹ / í•˜ë½ ì—¬ë¶€ë¡œ ì ì¤‘ì„ íŒë‹¨í•©ë‹ˆë‹¤.</li>
      </ol>
    </div>

    <a href="https://t.me/binance_pricechange" target="_blank" class="channel-banner">
      <span class="channel-icon">ğŸ’¬</span>
      <span class="channel-text"><b>ë°”ì´ë‚¸ìŠ¤ ê°€ê²© ê¸‰ë“±ë½ ì•Œë¦¬ë¯¸</b> â€” í…”ë ˆê·¸ë¨ ì±„ë„ ë°”ë¡œê°€ê¸°</span>
      <span class="channel-arrow">â†’</span>
    </a>
  </div>

  <!-- â”€â”€ í†µê³„ ì¹´ë“œ â”€â”€ -->
  <div class="stats">
    <div class="stat-card main">
      <div class="lbl">ğŸ¥” ì•Œê°ìì§€ìˆ˜</div>
      <div class="val" id="s-algamja">â€”</div>
    </div>
    <div class="stat-card">
      <div class="lbl">ì´ ì˜ˆì¸¡</div>
      <div class="val" id="s-total">â€”</div>
    </div>
    <div class="stat-card hits">
      <div class="lbl">âœ… ì´ ì ì¤‘</div>
      <div class="val" id="s-hit">â€”</div>
    </div>
    <div class="stat-card fails">
      <div class="lbl">âŒ ì´ ì‹¤íŒ¨</div>
      <div class="val" id="s-miss">â€”</div>
    </div>
  </div>

  <!-- â”€â”€ ìì‚°ë³„ ìš”ì•½ â”€â”€ -->
  <div class="asset-summary">
    <h3>ğŸ“Š ìì‚°ë³„ ì ì¤‘ë¥  í˜„í™©</h3>
    <div class="asset-grid" id="asset-grid">
      <span style="color:var(--muted)">ë¡œë”© ì¤‘...</span>
    </div>
  </div>

  <!-- â”€â”€ íˆ´ë°” â”€â”€ -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn btn-primary admin-only" onclick="openModal()">ï¼‹ ì˜ˆì¸¡ ì¶”ê°€</button>
      <button class="btn btn-secondary admin-only" id="btn-refresh" onclick="doRefresh()">ğŸ”„ ê°€ê²© ìƒˆë¡œê³ ì¹¨</button>
      <button class="admin-bar" id="btn-login-bar" onclick="openLoginModal()">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</button>
      <button class="admin-bar admin-only" id="btn-logout-bar" onclick="doLogout()">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="toolbar-right" id="last-update"></div>
  </div>

  <!-- â”€â”€ ì˜ˆì¸¡ í…Œì´ë¸” â”€â”€ -->
  <div class="tbl-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>ìì‚°ì‹œì¥</th>
          <th>ì–¸ê¸‰ë‚ ì§œ</th>
          <th>ì–¸ê¸‰ì‹œì  ê°€ê²©</th>
          <th>ë°©í–¥ì„±</th>
          <th>í˜„ì¬ ê°€ê²©</th>
          <th>ë³€ë™ë¥ </th>
          <th>ì ì¤‘ ìˆ˜</th>
          <th>ì‹¤íŒ¨ ìˆ˜</th>
          <th>ì•¡ì…˜</th>
        </tr>
      </thead>
      <tbody id="tbl-body">
        <tr><td colspan="10" class="tbl-empty">ë¡œë”© ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â”€â”€ ì„¤ì • (ê´€ë¦¬ì ì „ìš©) â”€â”€ -->
  <div class="settings admin-only">
    <h3>âš™ï¸ ìë™ ì—…ë°ì´íŠ¸ ì„¤ì • <span style="font-size:.75rem;color:var(--muted);font-weight:400">(ê´€ë¦¬ì ì „ìš©)</span></h3>
    <div class="settings-row">
      <div class="fld">
        <label>ì—…ë°ì´íŠ¸ ì£¼ê¸° (ê°€ê²© ìë™ê°±ì‹  + í…”ë ˆê·¸ë¨ ìë™ì „ì†¡)</label>
        <select id="sel-interval">
          <option value="1">1ë¶„</option>
          <option value="5" selected>5ë¶„</option>
          <option value="10">10ë¶„</option>
          <option value="30">30ë¶„</option>
          <option value="60">1ì‹œê°„</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="saveSettings()">ì €ì¥</button>
      <button class="btn btn-secondary" onclick="sendReportNow()">ğŸ“¤ ì§€ê¸ˆ í…”ë ˆê·¸ë¨ ì „ì†¡</button>
    </div>
    <p class="settings-info">ì„¤ì •ê°’ì€ DBì— ì €ì¥ë˜ì–´ ì„œë²„ ì¬ì‹œì‘ í›„ì—ë„ ìœ ì§€ë©ë‹ˆë‹¤.</p>
  </div>

  <!-- â”€â”€ ë°ì¼ë¦¬ ì°¨íŠ¸ â”€â”€ -->
  <div class="chart-section">
    <h3>ğŸ“ˆ ì•Œê°ìì§€ìˆ˜ ë°ì¼ë¦¬ ì´ë ¥</h3>
    <p class="chart-desc">50% ê¸°ì¤€ì„  ì´í•˜ì´ë©´ "ë°˜ëŒ€ë¡œ ê°€ëŠ” ê°€ì„¤"ì´ ì„±ë¦½í•©ë‹ˆë‹¤.</p>
    <div class="chart-wrap">
      <canvas id="chart"></canvas>
    </div>
  </div>

</div><!-- /wrap -->

<!-- â”€â”€ ì¶”ê°€ ëª¨ë‹¬ â”€â”€ -->
<div class="overlay" id="modal-overlay" onclick="overlayClick(event)">
  <div class="modal">
    <h2 id="modal-title">ï¼‹ ì˜ˆì¸¡ ì¶”ê°€</h2>

    <div class="form-row">
      <label>ìì‚°ì‹œì¥</label>
      <select id="f-asset" onchange="onAssetChange(this.value)">
        <option value="">â€” ì„ íƒí•˜ì„¸ìš” â€”</option>
        <optgroup label="â”€â”€ ì§€ìˆ˜ / ê¸°íƒ€ â”€â”€">
          <option>S&amp;P500</option>
          <option>NASDAQ</option>
          <option>KOSPI</option>
          <option>KOSDAQ</option>
          <option>ë¹„íŠ¸ì½”ì¸</option>
          <option>í™˜ìœ¨(ì›/ë‹¬ëŸ¬)</option>
          <option>ê¸ˆ</option>
          <option>ì€</option>
        </optgroup>
        <optgroup label="â”€â”€ ê°œë³„ì¢…ëª© â”€â”€">
          <option value="__NASDAQ__">NASDAQ ê°œë³„ì¢…ëª©</option>
          <option value="__NYSE__">NYSE ê°œë³„ì¢…ëª©</option>
          <option value="__SP500__">S&amp;P500 ê°œë³„ì¢…ëª©</option>
          <option value="__KOSPI__">KOSPI ê°œë³„ì¢…ëª©</option>
          <option value="__KOSDAQ__">KOSDAQ ê°œë³„ì¢…ëª©</option>
          <option value="__OTHER__">ê¸°íƒ€ ê±°ë˜ì†Œ ê°œë³„ì¢…ëª©</option>
        </optgroup>
      </select>
    </div>

    <!-- ê°œë³„ì¢…ëª© í‹°ì»¤ ì…ë ¥ (NASDAQ/NYSE/S&P500/ê¸°íƒ€ìš©) -->
    <div class="form-row" id="ticker-row" style="display:none">
      <label id="ticker-label">í‹°ì»¤</label>
      <div style="display:flex; gap:8px; align-items:center">
        <input type="text" id="f-ticker" placeholder="ì˜ˆ: AAPL" style="flex:1; text-transform:uppercase"
               oninput="this.value=this.value.toUpperCase()" onblur="checkTicker()">
        <span id="ticker-status" style="font-size:0.85rem; white-space:nowrap"></span>
      </div>
      <div id="ticker-hint" style="font-size:0.78rem; color:var(--muted); margin-top:4px"></div>
    </div>

    <!-- ì¢…ëª©ëª… ê²€ìƒ‰ (KOSPI/KOSDAQìš©) -->
    <div class="form-row" id="search-row" style="display:none">
      <label id="search-label">ì¢…ëª©ëª… ê²€ìƒ‰</label>
      <div style="position:relative">
        <div style="display:flex; gap:8px; align-items:center">
          <input type="text" id="f-search" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" style="flex:1" autocomplete="off"
                 oninput="onSearchInput(this.value)">
          <span id="search-status" style="font-size:0.85rem; white-space:nowrap; min-width:80px"></span>
        </div>
        <ul id="search-dropdown" style="display:none; position:absolute; z-index:200;
            background:var(--card2); border:1px solid var(--border); border-radius:var(--radius);
            width:100%; list-style:none; padding:4px 0; margin:2px 0 0;
            max-height:220px; overflow-y:auto; box-shadow:0 4px 12px rgba(0,0,0,.5)"></ul>
      </div>
      <div id="search-hint" style="font-size:0.78rem; color:var(--muted); margin-top:4px"></div>
    </div>

    <div class="form-row">
      <label>ì–¸ê¸‰ë‚ ì§œ (ìœ íŠœë¸Œ ì˜ìƒ ê²Œì‹œì¼)</label>
      <input type="date" id="f-date">
    </div>

    <div class="form-row">
      <label>ì–¸ê¸‰ì‹œì  ìì‚°ê°€ê²©</label>
      <input type="number" id="f-price" placeholder="ì˜ˆ: 4500" step="any" min="0">
    </div>

    <div class="form-row">
      <label>ë°©í–¥ì„±</label>
      <div class="dir-btns">
        <div class="dir-btn up"   id="db-up"   onclick="selDir('UP')">ğŸ“ˆ UP</div>
        <div class="dir-btn down" id="db-down" onclick="selDir('DOWN')">ğŸ“‰ DOWN</div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-primary"   style="flex:1" id="modal-submit-btn" onclick="submitForm()">ì¶”ê°€í•˜ê¸°</button>
      <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ë¡œê·¸ì¸ ëª¨ë‹¬ â”€â”€ -->
<div class="overlay" id="login-overlay" onclick="loginOverlayClick(event)">
  <div class="modal" style="max-width:360px">
    <h2>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <div class="form-row">
      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="login-pw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
             onkeydown="if(event.key==='Enter') doLogin()">
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="flex:1" onclick="doLogin()">ë¡œê·¸ì¸</button>
      <button class="btn btn-secondary" onclick="closeLoginModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ -->
<div id="toast"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìƒíƒœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let selDirection = '';
let algamjaChart = null;
let toastTimer   = null;
let editId       = null;   // null = ì¶”ê°€ ëª¨ë“œ, ìˆ«ì = ìˆ˜ì • ëª¨ë“œ
let isAdmin      = false;  // ê´€ë¦¬ì ì—¬ë¶€

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì´ˆê¸°í™”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', async () => {
  // admin-only ìš”ì†Œë¥¼ CSS ëŒ€ì‹  inline styleë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ (applyAdminUIì—ì„œ '' ë³µì› ì‹œ CSS ê°„ì„­ ë°©ì§€)
  document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
  document.getElementById('f-date').value = new Date().toISOString().slice(0, 10);
  await checkAuth();   // ì¸ì¦ ìƒíƒœ í™•ì¸ â†’ applyAdminUI í˜¸ì¶œ
  loadAll();
  setInterval(loadAll, 60_000);
});

async function loadAll() {
  await Promise.all([loadPredictions(), loadAssetStats(), loadChart(), loadSettings()]);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   í† ìŠ¤íŠ¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, duration = 2800) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), duration);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì˜ˆì¸¡ ëª©ë¡ ë¡œë“œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadPredictions() {
  try {
    const res  = await fetch('/api/predictions');
    const data = await res.json();

    // í†µê³„ ì¹´ë“œ
    document.getElementById('s-algamja').textContent = data.algamja_index.toFixed(1) + '%';
    document.getElementById('s-total').textContent   = data.predictions.length;
    document.getElementById('s-hit').textContent     = data.total_hit;
    document.getElementById('s-miss').textContent    = data.total_miss;

    // í…Œì´ë¸” ë Œë”
    const tbody = document.getElementById('tbl-body');
    if (!data.predictions.length) {
      tbody.innerHTML = `<tr><td colspan="10" class="tbl-empty">ì•„ì§ ì˜ˆì¸¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•´ ë³´ì„¸ìš” ğŸ¥”</td></tr>`;
      return;
    }

    tbody.innerHTML = data.predictions.map((p, i) => {
      const mentionFmt = fmtNum(p.mention_price);
      const curFmt     = p.current_price != null ? fmtNum(p.current_price) : '<span class="badge-pending">ê°±ì‹  ì¤‘</span>';

      let chg = '';
      if (p.current_price != null && p.mention_price) {
        const pct = ((p.current_price - p.mention_price) / p.mention_price * 100).toFixed(2);
        const cls = pct > 0 ? 'chg-up' : pct < 0 ? 'chg-down' : '';
        chg = `<span class="${cls}">${pct > 0 ? '+' : ''}${pct}%</span>`;
      } else {
        chg = '<span class="badge-pending">â€”</span>';
      }

      const dirCls  = p.direction === 'UP' ? 'dir-up' : 'dir-down';
      const dirIcon = p.direction === 'UP' ? 'ğŸ“ˆ UP' : 'ğŸ“‰ DOWN';

      // ì ì¤‘/ì‹¤íŒ¨: ê´€ë¦¬ìëŠ” ì§ì ‘ ìˆ«ì ì…ë ¥, ë°©ë¬¸ìëŠ” ìˆ«ì í‘œì‹œ
      const hitCell  = isAdmin
        ? `<input type="number" class="num-input" value="${p.hit}"
                  onchange="setResult(${p.id},'hit',this.value)" min="0">`
        : `<span class="num-display num-hit">${p.hit}</span>`;
      const missCell = isAdmin
        ? `<input type="number" class="num-input" value="${p.miss}"
                  onchange="setResult(${p.id},'miss',this.value)" min="0">`
        : `<span class="num-display num-miss">${p.miss}</span>`;

      // ì•¡ì…˜ ë²„íŠ¼: ê´€ë¦¬ìë§Œ
      const pTicker = p.ticker || '';
      const actions = isAdmin
        ? `<div class="btn-group">
             <button class="btn btn-sm btn-edit"
                     onclick="openEditModal(${p.id},'${p.asset_market}','${p.mention_date}',${p.mention_price},'${p.direction}','${pTicker}')">âœï¸</button>
             <button class="btn btn-sm btn-del"
                     onclick="delRow(${p.id})">ğŸ—‘</button>
           </div>`
        : '';

      return `
        <tr>
          <td style="color:var(--muted)">${data.predictions.length - i}</td>
          <td><strong>${p.asset_market}</strong></td>
          <td>${p.mention_date}</td>
          <td>${mentionFmt}</td>
          <td class="${dirCls}">${dirIcon}</td>
          <td>${curFmt}</td>
          <td>${chg}</td>
          <td>${hitCell}</td>
          <td>${missCell}</td>
          <td>${actions}</td>
        </tr>`;
    }).join('');

    document.getElementById('last-update').textContent =
      'ë§ˆì§€ë§‰ ê°±ì‹ : ' + new Date().toLocaleString('ko-KR');

  } catch (e) {
    console.error(e);
    document.getElementById('tbl-body').innerHTML =
      `<tr><td colspan="11" class="tbl-empty">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìì‚°ë³„ ìš”ì•½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadAssetStats() {
  try {
    const rows = await (await fetch('/api/asset-stats')).json();
    const grid = document.getElementById('asset-grid');

    if (!rows.length) {
      grid.innerHTML = '<span style="color:var(--muted)">ë°ì´í„° ì—†ìŒ</span>';
      return;
    }

    grid.innerHTML = rows.map(r => {
      const total = r.total_hit + r.total_miss;
      const rate  = total ? Math.round(r.total_hit / total * 100) : null;
      const rateStr = rate !== null ? `${rate}%` : 'N/A';
      const barW    = rate !== null ? rate : 0;
      const barClr  = rate !== null
        ? (rate >= 50 ? 'var(--hit-col)' : 'var(--miss-col)')
        : 'var(--muted)';

      return `
        <div class="asset-chip">
          <div class="name">${r.asset_market}</div>
          <div class="rate" style="color:${barClr};font-size:.82rem;font-weight:600;">
            ${rateStr}
            <span style="color:var(--muted);font-weight:400;font-size:.78rem;">
              (${r.total_hit}ì ì¤‘ / ${r.total_count}ê±´)
            </span>
          </div>
          <div class="rate-bar-wrap">
            <div class="rate-bar" style="width:${barW}%;background:${barClr}"></div>
          </div>
        </div>`;
    }).join('');
  } catch (e) { console.error(e); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì ì¤‘/ì‹¤íŒ¨ ìˆ«ì ì €ì¥ (ê´€ë¦¬ì ì „ìš©)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function setResult(id, field, value) {
  try {
    const r = await fetch(`/api/predictions/${id}/result`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ [field]: Math.max(0, parseInt(value) || 0) }),
    });
    const d = await r.json();
    if (d.success) {
      await loadAll();
      toast(`âœ… ${field === 'hit' ? 'ì ì¤‘' : 'ì‹¤íŒ¨'} ìˆ˜ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤`);
    } else {
      toast('ì˜¤ë¥˜: ' + (d.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  } catch (e) { toast('ì˜¤ë¥˜: ' + e.message); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì‚­ì œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function delRow(id) {
  if (!confirm('ì´ ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await fetch(`/api/predictions/${id}`, { method: 'DELETE' });
    await loadAll();
    toast('ğŸ—‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (e) { toast('ì‚­ì œ ì˜¤ë¥˜: ' + e.message); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ê°€ê²© ìƒˆë¡œê³ ì¹¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function doRefresh() {
  const btn = document.getElementById('btn-refresh');
  btn.disabled = true;
  btn.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';
  try {
    await fetch('/api/refresh', { method: 'POST' });
    toast('â³ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘ (ì•½ 10~20ì´ˆ ì†Œìš”)');
    setTimeout(async () => {
      await loadAll();
      btn.disabled    = false;
      btn.textContent = 'ğŸ”„ ê°€ê²© ìƒˆë¡œê³ ì¹¨';
      toast('âœ… ê°€ê²©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
    }, 15_000);
  } catch (e) {
    btn.disabled = false;
    btn.textContent = 'ğŸ”„ ê°€ê²© ìƒˆë¡œê³ ì¹¨';
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   í…”ë ˆê·¸ë¨ ì¦‰ì‹œ ì „ì†¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function sendReportNow() {
  try {
    toast('ğŸ“¤ í…”ë ˆê·¸ë¨ ì „ì†¡ ì¤‘...');
    const r = await fetch('/api/send-report', { method: 'POST' });
    const d = await r.json();
    if (d.success) toast('âœ… í…”ë ˆê·¸ë¨ ì±„ë„ì— ì „ì†¡í–ˆìŠµë‹ˆë‹¤');
    else toast('ì˜¤ë¥˜: ' + (d.error || 'ì „ì†¡ ì‹¤íŒ¨'));
  } catch (e) { toast('ì „ì†¡ ì˜¤ë¥˜: ' + e.message); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì„¤ì • ë¡œë“œ / ì €ì¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSettings() {
  try {
    const s = await (await fetch('/api/settings')).json();
    if (s.update_interval) {
      document.getElementById('sel-interval').value = s.update_interval;
    }
  } catch (e) { console.error(e); }
}

async function saveSettings() {
  const v = document.getElementById('sel-interval').value;
  try {
    const r = await fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ update_interval: v }),
    });
    if ((await r.json()).success) toast(`âš™ï¸ ì—…ë°ì´íŠ¸ ì£¼ê¸°ë¥¼ ${v}ë¶„ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤`);
  } catch (e) { toast('ì„¤ì • ì €ì¥ ì‹¤íŒ¨'); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Chart.js
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadChart() {
  try {
    const data   = await (await fetch('/api/daily-index')).json();
    const labels = data.map(d => d.date);
    const values = data.map(d => d.algamja_index);

    if (algamjaChart) {
      algamjaChart.data.labels            = labels;
      algamjaChart.data.datasets[0].data  = values;
      algamjaChart.data.datasets[1].data  = labels.map(() => 50);
      algamjaChart.update('none');
      return;
    }

    const ctx = document.getElementById('chart').getContext('2d');
    algamjaChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'ì•Œê°ìì§€ìˆ˜ (%)',
            data: values,
            borderColor: '#f5a623',
            backgroundColor: 'rgba(245,166,35,0.08)',
            borderWidth: 2.5,
            pointBackgroundColor: '#f5a623',
            pointBorderColor: '#0d0d0d',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            fill: true,
            tension: 0.35,
          },
          {
            label: '50% ê¸°ì¤€ì„ ',
            data: labels.map(() => 50),
            borderColor: 'rgba(255,255,255,0.2)',
            borderWidth: 1.5,
            borderDash: [6, 5],
            pointRadius: 0,
            fill: false,
            tension: 0,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            labels: { color: '#888', usePointStyle: true, pointStyleWidth: 10 },
          },
          tooltip: {
            backgroundColor: '#1e1e1e',
            borderColor: '#2a2a2a',
            borderWidth: 1,
            titleColor: '#e2e2e2',
            bodyColor: '#aaa',
            callbacks: {
              label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`,
            },
          },
        },
        scales: {
          x: {
            ticks: { color: '#666', maxRotation: 45 },
            grid:  { color: '#1a1a1a' },
          },
          y: {
            min: 0, max: 100,
            ticks: { color: '#666', callback: v => v + '%', stepSize: 25 },
            grid:  { color: '#1a1a1a' },
          },
        },
      },
    });
  } catch (e) { console.error('chart error', e); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ëª¨ë‹¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openModal() {
  if (!isAdmin) { toast('âš ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
  editId = null;
  document.getElementById('modal-title').textContent = 'ï¼‹ ì˜ˆì¸¡ ì¶”ê°€';
  document.getElementById('modal-submit-btn').textContent = 'ì¶”ê°€í•˜ê¸°';
  document.getElementById('modal-overlay').classList.add('show');
}

// â”€â”€ ê°œë³„ì¢…ëª© í‹°ì»¤ ê´€ë ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CUSTOM_MARKETS = {
  '__NASDAQ__': { label: 'í‹°ì»¤ (ì˜ˆ: AAPL, TSLA, MSFT)',   hint: 'NASDAQ í‹°ì»¤ë¥¼ ëŒ€ë¬¸ìë¡œ ì…ë ¥í•˜ì„¸ìš”',                      suffix: '', placeholder: 'ì˜ˆ: AAPL',       searchMode: false },
  '__NYSE__':   { label: 'í‹°ì»¤ (ì˜ˆ: JPM, BAC, GS)',        hint: 'NYSE í‹°ì»¤ë¥¼ ëŒ€ë¬¸ìë¡œ ì…ë ¥í•˜ì„¸ìš”',                        suffix: '', placeholder: 'ì˜ˆ: JPM',        searchMode: false },
  '__SP500__':  { label: 'í‹°ì»¤ (ì˜ˆ: AAPL, MSFT, GOOGL)',  hint: 'S&P500 êµ¬ì„±ì¢…ëª© í‹°ì»¤ë¥¼ ëŒ€ë¬¸ìë¡œ ì…ë ¥í•˜ì„¸ìš”',             suffix: '', placeholder: 'ì˜ˆ: AAPL',       searchMode: false },
  '__KOSPI__':  { label: 'ì¢…ëª©ëª… ê²€ìƒ‰',                    hint: 'ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤ (ì˜ˆ: ì‚¼ì„±ì „ì, í˜„ëŒ€ì°¨)', suffix: '.KS', placeholder: 'ì˜ˆ: ì‚¼ì„±ì „ì', searchMode: true  },
  '__KOSDAQ__': { label: 'ì¢…ëª©ëª… ê²€ìƒ‰',                    hint: 'ì¢…ëª©ëª…ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤ (ì˜ˆ: ì¹´ì¹´ì˜¤, ì…€íŠ¸ë¦¬ì˜¨)',  suffix: '.KQ', placeholder: 'ì˜ˆ: ì¹´ì¹´ì˜¤',   searchMode: true  },
  '__OTHER__':  { label: 'yfinance í‹°ì»¤ (ì˜ˆ: 9988.HK)',   hint: 'ê±°ë˜ì†Œ ì ‘ë¯¸ì‚¬ í¬í•¨í•˜ì—¬ ì…ë ¥ (ì˜ˆ: ì¢…ëª©ì½”ë“œ.HK, .T, .L)', suffix: '', placeholder: 'ì˜ˆ: 9988.HK',    searchMode: false },
};

// ê²€ìƒ‰ ëª¨ë“œì—ì„œ ì„ íƒëœ ì¢…ëª© ì •ë³´
let _selectedTicker = '';   // ê°€ê²© ì¡°íšŒìš© í‹°ì»¤ (ì˜ˆ: 005930.KS)
let _selectedName   = '';   // í‘œì‹œëª… (ì˜ˆ: ì‚¼ì„±ì „ì)
let _searchTimer    = null;

function onAssetChange(val) {
  const m        = CUSTOM_MARKETS[val];
  const isCustom = !!m;
  const isSearch = isCustom && m.searchMode;

  document.getElementById('ticker-row').style.display = (isCustom && !isSearch) ? '' : 'none';
  document.getElementById('search-row').style.display = (isCustom && isSearch)  ? '' : 'none';

  if (isCustom) {
    if (isSearch) {
      document.getElementById('search-label').textContent      = m.label;
      document.getElementById('search-hint').textContent       = m.hint;
      document.getElementById('f-search').placeholder          = m.placeholder;
      document.getElementById('f-search').value                = '';
      document.getElementById('search-status').textContent     = '';
      document.getElementById('search-dropdown').style.display = 'none';
      _selectedTicker = '';
      _selectedName   = '';
    } else {
      document.getElementById('ticker-label').textContent  = m.label;
      document.getElementById('ticker-hint').textContent   = m.hint;
      document.getElementById('f-ticker').placeholder      = m.placeholder;
      document.getElementById('f-ticker').value            = '';
      document.getElementById('ticker-status').textContent = '';
    }
  }
}

// â”€â”€ ì¢…ëª©ëª… ê²€ìƒ‰ (KOSPI/KOSDAQ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onSearchInput(val) {
  _selectedTicker = '';
  _selectedName   = '';
  document.getElementById('search-status').textContent = '';
  clearTimeout(_searchTimer);
  const dd = document.getElementById('search-dropdown');
  if (!val.trim()) { dd.style.display = 'none'; return; }
  _searchTimer = setTimeout(() => doSearch(val.trim()), 450);
}

async function doSearch(query) {
  const market = document.getElementById('f-asset').value;
  const suffix = CUSTOM_MARKETS[market]?.suffix ?? '';
  try {
    const r = await fetch(`/api/search-ticker-name?q=${encodeURIComponent(query)}&suffix=${encodeURIComponent(suffix)}`);
    const results = await r.json();
    const dd = document.getElementById('search-dropdown');
    if (!results.length) {
      dd.innerHTML = '<li style="padding:8px 12px; color:var(--muted)">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</li>';
    } else {
      dd.innerHTML = results.map(res => {
        const safeName   = res.name.replace(/'/g, "\\'");
        const safeTicket = res.ticker;
        return `<li style="padding:9px 14px; cursor:pointer; border-bottom:1px solid var(--border)"
                    onmouseover="this.style.background='var(--card)'"
                    onmouseout="this.style.background=''"
                    onmousedown="selectSearchResult('${safeTicket}','${safeName}','${res.exchange}')">
                  <strong>${res.name}</strong>
                  <span style="color:var(--muted); font-size:0.82rem; margin-left:6px">${res.ticker} Â· ${res.exchange}</span>
                </li>`;
      }).join('');
    }
    dd.style.display = 'block';
  } catch (e) { /* ignore */ }
}

function selectSearchResult(ticker, name, exchange) {
  _selectedTicker = ticker;  // ë‚´ë¶€ ê°€ê²© ì¡°íšŒìš©
  _selectedName   = name;    // í‘œì‹œëª… (DB ì €ì¥ìš©)
  document.getElementById('f-search').value                = name;
  document.getElementById('search-dropdown').style.display = 'none';
  const statusEl = document.getElementById('search-status');
  statusEl.textContent = `âœ… ${ticker} (${exchange})`;
  statusEl.style.color = 'var(--up)';
}

// ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
document.addEventListener('click', e => {
  const dd = document.getElementById('search-dropdown');
  if (dd && !dd.contains(e.target) && e.target.id !== 'f-search') {
    dd.style.display = 'none';
  }
});

async function checkTicker() {
  const market = document.getElementById('f-asset').value;
  if (!(market in CUSTOM_MARKETS) || CUSTOM_MARKETS[market].searchMode) return;
  const raw      = document.getElementById('f-ticker').value.trim().toUpperCase();
  if (!raw) return;
  const statusEl = document.getElementById('ticker-status');
  statusEl.textContent = 'â³ í™•ì¸ ì¤‘...';
  statusEl.style.color = 'var(--muted)';
  try {
    const r = await fetch('/api/validate-ticker', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticker: raw }),
    });
    const d = await r.json();
    if (d.valid) {
      statusEl.textContent = `âœ… ${d.price?.toLocaleString() ?? ''} (${d.exchange ?? ''})`;
      statusEl.style.color = 'var(--up)';
    } else {
      statusEl.textContent = 'âŒ í‹°ì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
      statusEl.style.color = 'var(--down)';
    }
  } catch (e) {
    statusEl.textContent = '';
  }
}

function getAssetMarket() {
  const sel = document.getElementById('f-asset').value;
  if (!(sel in CUSTOM_MARKETS)) return sel;
  // ê²€ìƒ‰ ëª¨ë“œ: í‘œì‹œëª…(_selectedName)ì„ asset_marketìœ¼ë¡œ ì €ì¥, í‹°ì»¤ëŠ” ë³„ë„ ì „ì†¡
  if (CUSTOM_MARKETS[sel].searchMode) return _selectedName;
  return document.getElementById('f-ticker').value.trim().toUpperCase();
}

function getTickerForSubmit() {
  const sel = document.getElementById('f-asset').value;
  if ((sel in CUSTOM_MARKETS) && CUSTOM_MARKETS[sel].searchMode) return _selectedTicker || null;
  return null;  // US ì£¼ì‹ì€ asset_market ìì²´ê°€ í‹°ì»¤ì´ë¯€ë¡œ ë³„ë„ ë¶ˆí•„ìš”
}

// â”€â”€ ëª¨ë‹¬ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditModal(id, asset, date, price, direction, ticker) {
  editId = id;
  document.getElementById('modal-title').textContent = 'âœï¸ ì˜ˆì¸¡ ìˆ˜ì •';
  document.getElementById('modal-submit-btn').textContent = 'ìˆ˜ì •í•˜ê¸°';

  // ê³ ì • ìì‚° ì—¬ë¶€ í™•ì¸
  const fixedAssets = ['S&P500','NASDAQ','KOSPI','KOSDAQ','ë¹„íŠ¸ì½”ì¸','í™˜ìœ¨(ì›/ë‹¬ëŸ¬)','ê¸ˆ','ì€'];
  if (fixedAssets.includes(asset)) {
    document.getElementById('f-asset').value = asset;
    document.getElementById('ticker-row').style.display = 'none';
    document.getElementById('search-row').style.display = 'none';
  } else {
    // ê°œë³„ì¢…ëª©: tickerê°€ ìˆìœ¼ë©´ KOSPI/KOSDAQ, ì—†ìœ¼ë©´ í‹°ì»¤ë¡œ ê±°ë˜ì†Œ ì¶”ì •
    let market = '__OTHER__';
    if (ticker && ticker.endsWith('.KS'))       market = '__KOSPI__';
    else if (ticker && ticker.endsWith('.KQ'))  market = '__KOSDAQ__';
    else if (!asset.includes('.') && !ticker)   market = '__NASDAQ__';
    document.getElementById('f-asset').value = market;
    onAssetChange(market);
    if (CUSTOM_MARKETS[market].searchMode) {
      // ê²€ìƒ‰ ëª¨ë“œ: asset(í‘œì‹œëª…)ì„ ê²€ìƒ‰ì°½ì—, tickerë¥¼ ë‚´ë¶€ ë³€ìˆ˜ì— ë³µì›
      _selectedName   = asset;
      _selectedTicker = ticker || '';
      document.getElementById('f-search').value            = asset;
      document.getElementById('search-status').textContent = ticker ? `âœ… ${ticker}` : 'âœ… ì„ íƒë¨';
      document.getElementById('search-status').style.color = 'var(--up)';
    } else {
      document.getElementById('f-ticker').value = asset;
    }
  }
  document.getElementById('f-date').value  = date;
  document.getElementById('f-price').value = price;
  selDir(direction);
  document.getElementById('modal-overlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('show');
  resetForm();
}
function overlayClick(e) {
  if (e.target === e.currentTarget) closeModal();
}
function resetForm() {
  editId = null;
  _selectedTicker = '';
  _selectedName   = '';
  document.getElementById('f-asset').value  = '';
  document.getElementById('f-price').value  = '';
  document.getElementById('f-ticker').value = '';
  document.getElementById('f-search').value = '';
  document.getElementById('ticker-row').style.display      = 'none';
  document.getElementById('search-row').style.display      = 'none';
  document.getElementById('search-dropdown').style.display = 'none';
  document.getElementById('ticker-status').textContent     = '';
  document.getElementById('search-status').textContent     = '';
  selDirection = '';
  document.getElementById('db-up').classList.remove('sel');
  document.getElementById('db-down').classList.remove('sel');
}
function selDir(dir) {
  selDirection = dir;
  document.getElementById('db-up').classList.toggle('sel',   dir === 'UP');
  document.getElementById('db-down').classList.toggle('sel', dir === 'DOWN');
}

async function submitForm() {
  const asset = getAssetMarket();
  const dt    = document.getElementById('f-date').value;
  const price = document.getElementById('f-price').value;

  if (!asset)        { toast('âš ï¸ ìì‚°ì‹œì¥ì„ ì„ íƒí•˜ì„¸ìš”');    return; }
  if (!dt)           { toast('âš ï¸ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”');         return; }
  if (!price)        { toast('âš ï¸ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”');         return; }
  if (!selDirection) { toast('âš ï¸ ë°©í–¥ì„±ì„ ì„ íƒí•˜ì„¸ìš”');       return; }

  const body = {
    asset_market:  asset,
    mention_date:  dt,
    mention_price: parseFloat(price),
    direction:     selDirection,
  };
  const ticker = getTickerForSubmit();
  if (ticker) body.ticker = ticker;

  try {
    const url    = editId ? `/api/predictions/${editId}` : '/api/predictions';
    const method = editId ? 'PUT' : 'POST';
    const r = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const d = await r.json();
    if (d.success) {
      closeModal();
      await loadAll();
      toast(editId ? 'âœ… ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'âœ… ì˜ˆì¸¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    } else {
      toast('ì˜¤ë¥˜: ' + (d.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    }
  } catch (e) { toast('ì˜¤ë¥˜: ' + e.message); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì¸ì¦ (ê´€ë¦¬ì ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function checkAuth() {
  try {
    const r = await fetch('/api/auth-status');
    const d = await r.json();
    isAdmin = d.is_admin;
    applyAdminUI();
  } catch (e) { console.error(e); }
}

function applyAdminUI() {
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });
  const loginBar = document.getElementById('btn-login-bar');
  if (loginBar) loginBar.style.display = isAdmin ? 'none' : '';
}

function openLoginModal() {
  document.getElementById('login-pw').value = '';
  document.getElementById('login-overlay').classList.add('show');
  setTimeout(() => document.getElementById('login-pw').focus(), 80);
}
function closeLoginModal() {
  document.getElementById('login-overlay').classList.remove('show');
}
function loginOverlayClick(e) {
  if (e.target === e.currentTarget) closeLoginModal();
}

async function doLogin() {
  const pw = document.getElementById('login-pw').value;
  if (!pw) return;
  try {
    const r = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw }),
    });
    const d = await r.json();
    if (d.success) {
      isAdmin = true;
      closeLoginModal();
      applyAdminUI();
      await loadAll();
      toast('âœ… ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤');
    } else {
      toast('âŒ ' + (d.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'));
    }
  } catch (e) { toast('ì˜¤ë¥˜: ' + e.message); }
}

async function doLogout() {
  await fetch('/api/logout', { method: 'POST' });
  isAdmin = false;
  applyAdminUI();
  await loadAll();
  toast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìœ í‹¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function fmtNum(n) {
  if (n == null) return 'â€”';
  return Number(n).toLocaleString('ko-KR', { maximumFractionDigits: 2 });
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeLoginModal(); }
});
</script>
</body>
</html>
